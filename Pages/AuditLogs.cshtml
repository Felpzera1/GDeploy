@page
@model GtopPdqNet.Pages.AuditLogsModel
@{
    ViewData["Title"] = "Logs de Auditoria";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="text-light">
                    <!-- <i class="fas fa-clipboard-list me-2"></i> -->
                </h2>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-outline-info btn-sm" onclick="refreshLogs()">
                        <i class="fas fa-sync-alt me-1"></i>
                        Atualizar
                    </button>
                    <!-- <button type="button" class="btn btn-outline-info btn-sm" onclick="exportLogs()">
                        <i class="fas fa-download me-1"></i> 
                        Exportar -->
                    </button>
                </div>
            </div>

            @if (ViewData["ErrorMessage"] != null)
            {
                <div class="alert alert-danger" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    @ViewData["ErrorMessage"]
                </div>
            }

            <div class="card bg-dark border-secondary">
                <div class="card-header bg-secondary text-light">
                    <h5 class="mb-0">
                        <i class="fas fa-history me-2"></i>
                        Histórico de Deploys
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-dark table-striped table-hover mb-0">
                            <thead class="table-secondary">
                                <tr>
                                    <th scope="col">
                                        <i class="fas fa-clock me-1"></i>
                                        Data/Hora
                                    </th>
                                    <th scope="col">
                                        <i class="fas fa-user me-1"></i>
                                        Usuário
                                    </th>
                                    <th scope="col">
                                        <i class="fas fa-server me-1"></i>
                                        Hostname
                                    </th>
                                    <th scope="col">
                                        <i class="fas fa-box me-1"></i>
                                        Pacote
                                    </th>
                                    <th scope="col">
                                        <i class="fas fa-check-circle me-1"></i>
                                        Status
                                    </th>
                                    <th scope="col">
                                        <i class="fas fa-cogs me-1"></i>
                                        Ações
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="auditTableBody">
                                <tr>
                                    <td colspan="6" class="text-center text-muted py-4">
                                        <div class="d-flex flex-column align-items-center">
                                            <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
                                            <span>Carregando logs de auditoria...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Elemento oculto para passar o JSON para o JavaScript -->
<script type="application/json" id="auditDataJson">@Html.Raw(Model.AuditLogs ?? "[]")</script>

<!-- Modal para exibir detalhes do log -->
<div class="modal fade" id="logDetailModal" tabindex="-1" aria-labelledby="logDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark border-secondary">
            <div class="modal-header bg-secondary">
                <h5 class="modal-title text-light" id="logDetailModalLabel">
                    <i class="fas fa-info-circle me-2"></i>
                    Detalhes do Deploy
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="logDetailContent" class="text-light">
                    <!-- Conteúdo será preenchido via JavaScript -->
                </div>
            </div>
            <div class="modal-footer bg-secondary">
                <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para exibir log completo -->
<div class="modal fade" id="detailedLogModal" tabindex="-1" aria-labelledby="detailedLogModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content bg-dark border-secondary">
            <div class="modal-header bg-secondary">
                <h5 class="modal-title text-light" id="detailedLogModalLabel">
                    <i class="fas fa-file-alt me-2"></i>
                    Log Completo do Deploy
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="detailedLogContent" class="text-light">
                    <!-- Conteúdo será preenchido via JavaScript -->
                </div>
            </div>
            <div class="modal-footer bg-secondary">
                <!-- <button type="button" class="btn btn-outline-info" onclick="downloadDetailedLog()">
                    <i class="fas fa-download me-1"></i>
                    Baixar Log -->
                </button>
                <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            loadAuditLogs();
        });

        function loadAuditLogs() {
            try {
                // Obter os dados de auditoria do elemento oculto
                const auditDataString = document.getElementById("auditDataJson").textContent;
                console.log("Raw audit data string from hidden element:", auditDataString);
                
                const auditData = JSON.parse(auditDataString);
                console.log("Parsed audit data:", auditData);
                console.log("Audit data type:", typeof auditData);
                console.log("Audit data length:", Array.isArray(auditData) ? auditData.length : "Not an array");
                
                const tableBody = document.getElementById("auditTableBody");
                
                if (!auditData || (Array.isArray(auditData) && auditData.length === 0)) {
                    console.log("No audit data found or empty array");
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center text-muted py-4">
                                <div class="d-flex flex-column align-items-center">
                                    <i class="fas fa-info-circle fa-2x mb-2"></i>
                                    <span>Nenhum log de auditoria encontrado</span>
                                    <small class="mt-1">Execute um deploy para gerar logs</small>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }

                // Verificar se auditData é um array
                if (!Array.isArray(auditData)) {
                    console.error("Audit data is not an array:", typeof auditData);
                    // Tentar converter objeto único em array
                    const convertedData = [auditData];
                    console.log("Converted to array:", convertedData);
                    processAuditData(convertedData, tableBody);
                } else {
                    console.log("Processing audit data array with", auditData.length, "entries");
                    processAuditData(auditData, tableBody);
                }
                
            } catch (e) {
                console.error("Erro ao processar logs de auditoria:", e);
                const tableBody = document.getElementById("auditTableBody");
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-danger py-4">
                            <div class="d-flex flex-column align-items-center">
                                <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                                <span>Erro ao carregar logs de auditoria</span>
                                <small class="mt-1">Verifique o console do navegador para mais detalhes</small>
                            </div>
                        </td>
                    </tr>
                `;
            }
        }

        function processAuditData(auditData, tableBody) {
            tableBody.innerHTML = "";
            
            auditData.forEach((log, index) => {
                console.log("Processing log entry", index, ":", log);
                
                const row = document.createElement("tr");
                
                const statusBadge = log.Success ? 
                    "<span class=\"badge bg-success\"><i class=\"fas fa-check me-1\"></i>Sucesso</span>" : 
                    "<span class=\"badge bg-danger\"><i class=\"fas fa-times me-1\"></i>Falha</span>";
                
                row.innerHTML = `
                    <td class="text-nowrap">${log.Timestamp || "N/A"}</td>
                    <td class="text-truncate" style="max-width: 200px;" title="${log.Username || "N/A"}">${log.Username || "N/A"}</td>
                    <td>${log.Hostname || "N/A"}</td>
                    <td class="text-truncate" style="max-width: 250px;" title="${log.PackageName || log.TemplateName || "N/A"}">${log.PackageName || log.TemplateName || "N/A"}</td>
                    <td>${statusBadge}</td>
                    <td class="text-nowrap">
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-outline-primary" onclick="showLogDetail(${index})" title="Ver detalhes">
                                <i class="fas fa-eye"></i>
                                <span class="d-none d-md-inline ms-1">Detalhes</span>
                            </button>
                            <button class="btn btn-sm btn-outline-info" onclick="showDetailedLog('${log.Timestamp}', '${log.Hostname}', '${log.Username}')" title="Log completo">
                                <i class="fas fa-file-alt"></i>
                                <span class="d-none d-md-inline ms-1">Log</span>
                            </button>
                        </div>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
            
            // Armazenar os dados globalmente para uso no modal
            window.auditLogsData = auditData;
            console.log("Audit logs data stored globally:", window.auditLogsData);
        }

        function showLogDetail(index) {
            if (!window.auditLogsData || !window.auditLogsData[index]) {
                alert("Log não encontrado");
                return;
            }

            const log = window.auditLogsData[index];
            const statusIcon = log.Success ? 
                "<i class=\"fas fa-check-circle text-success me-2\"></i>" : 
                "<i class=\"fas fa-times-circle text-danger me-2\"></i>";
            
            const content = `
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-clock me-2"></i>Data/Hora:</h6>
                        <p class="text-info">${log.Timestamp}</p>
                        
                        <h6><i class="fas fa-user me-2"></i>Usuário:</h6>
                        <p class="text-info">${log.Username}</p>
                        
                        <h6><i class="fas fa-server me-2"></i>Hostname:</h6>
                        <p class="text-info">${log.Hostname}</p>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-box me-2"></i>Pacote:</h6>
                        <p class="text-info">${log.PackageName}</p>
                        
                        <h6><i class="fas fa-check-circle me-2"></i>Status:</h6>
                        <p>${statusIcon}${log.Success ? "Sucesso" : "Falha"}</p>
                    </div>
                </div>
                
                <h6><i class="fas fa-terminal me-2"></i>Output:</h6>
                <div class="bg-secondary p-3 rounded">
                    <pre class="text-light mb-0" style="white-space: pre-wrap;">${log.Output || "Nenhum output disponível"}</pre>
                </div>
            `;
            
            document.getElementById("logDetailContent").innerHTML = content;
            new bootstrap.Modal(document.getElementById("logDetailModal")).show();
        }

        function showDetailedLog(timestamp, hostname, username) {
            // Fazer requisição para obter o log detalhado
            const url = `/AuditLogs?handler=DetailedLog&timestamp=${encodeURIComponent(timestamp)}&hostname=${encodeURIComponent(hostname)}&username=${encodeURIComponent(username)}`;
            
            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error("Log detalhado não encontrado");
                    }
                    return response.json();
                })
                .then(data => {
                    const content = `
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <h6><i class="fas fa-clock me-2"></i>Data/Hora:</h6>
                                <p class="text-info">${data.Timestamp}</p>
                            </div>
                            <div class="col-md-4">
                                <h6><i class="fas fa-user me-2"></i>Usuário:</h6>
                                <p class="text-info">${data.Username}</p>
                            </div>
                            <div class="col-md-4">
                                <h6><i class="fas fa-server me-2"></i>Hostname:</h6>
                                <p class="text-info">${data.Hostname}</p>
                            </div>
                        </div>
                        
                        <h6><i class="fas fa-box me-2"></i>Pacote:</h6>
                        <p class="text-info mb-3">${data.PackageName}</p>
                        
                        <h6><i class="fas fa-terminal me-2"></i>Log Detalhado:</h6>
                        <div class="bg-secondary p-3 rounded" style="max-height: 400px; overflow-y: auto;">
                            <pre class="text-light mb-0" style="white-space: pre-wrap;">${data.DetailedOutput || data.Output || "Nenhum log detalhado disponível"}</pre>
                        </div>
                    `;
                    
                    document.getElementById("detailedLogContent").innerHTML = content;
                    window.currentDetailedLog = data;
                    new bootstrap.Modal(document.getElementById("detailedLogModal")).show();
                })
                .catch(error => {
                    console.error("Erro ao carregar log detalhado:", error);
                    alert("Erro ao carregar log detalhado: " + error.message);
                });
        }

        function refreshLogs() {
            location.reload();
        }

        function exportLogs() {
            // Implementação da função de exportação
            if (!window.auditLogsData || window.auditLogsData.length === 0) {
                alert("Nenhum log para exportar.");
                return;
            }

            const headers = ["Timestamp", "Username", "Hostname", "PackageName", "Success", "Output"];
            const rows = window.auditLogsData.map(log => [
                `"${log.Timestamp || ""}"`,
                `"${log.Username || ""}"`,
                `"${log.Hostname || ""}"`,
                `"${log.PackageName || ""}"`,
                `"${log.Success ? "true" : "false"}"`,
                `"${(log.Output || "").replace(/"/g, "\"")}"` // Escape double quotes in output
            ]);

            let csvContent = headers.join(",") + "\n";
            rows.forEach(row => {
                csvContent += row.join(",") + "\n";
            });

            const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
            const link = document.createElement("a");
            if (link.download !== undefined) { // Feature detection
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", "audit_logs.csv");
                link.style.visibility = "hidden";
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        function downloadDetailedLog() {
            if (!window.currentDetailedLog) {
                alert("Nenhum log detalhado para baixar.");
                return;
            }

            const logContent = JSON.stringify(window.currentDetailedLog, null, 2);
            const blob = new Blob([logContent], { type: "application/json;charset=utf-8;" });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `detailed_log_${window.currentDetailedLog.Timestamp.replace(/[^a-zA-Z0-9]/g, ".")}.json`);
            link.style.visibility = "hidden";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
}
